# Вышел Firebird 4.0

Сегодня выпущен Firebird 4.0 — седьмой основной релиз СУБД Firebird, разработка которой началась в 2016 году. Ключевыми задачами при разработке Firebird 4.0 было повышение доступности баз данных (синхронная и асинхронная логическая репликация). 

Одним из самых важных улучшений в Firebird 4.0 стало изменение подхода к созданию согласованного представления о состоянии базы данных, видимого для выполняющихся транзакций. Это позволило решить проблему согласованного чтения на уровне запроса в транзакциях Read Committed, а также ввести так называемую промежуточную сборку мусора. Промежуточная сборка мусора позволяет дополнительно сократить длину цепочки версий при наличии длительных активных транзакций.

Среди важных улучшений также можно отметить поддержку чисел с точностью более 18 цифр, улучшение точности вычислений для более коротких чисел, поддержка часовых поясов, увеличение длины имён метаданных до 63 символов, улучшение подсистемы безопасности, физический standby на основе nbackup, таймауты простоя соединения и выполнения SQL запроса, Batch API, а также множество новые возможностей языка SQL.

Далее мы перечислим ключевые улучшения сделанные в Firebird 4.0 и их краткое описание. Подробное описание всех изменений можно прочитать в "Firebird 4.0 Release Notes".

## Логическая репликация

В Firebird 4.0 предоставляет встроенную поддержку однонаправленной логической репликации. Реализация в первую очередь направлена на обеспечение высокой доступности, но может использоваться и для других задач. 

Репликация отслеживает следующий события:
* добавление, обновление и удаление записей в таблицах
* изменение последовательностей (генераторов)
* DDL операторы

Поддерживается синхронный и асинхронный режим.

При синхронной репликации основная (главная) база данных постоянно подключена к реплике (подчиненным) базам данных, и изменения реплицируются немедленно. По сути, базы данных синхронизируются после каждой фиксации каждой транзакции, что может повлиять на производительность из-за дополнительного сетевого трафика.

При асинхронной репликации изменения записываются в файлы локального журнала, которые передаются по сети и применяются к базе данной реплике. Влияние на производительность намного меньше, но вызывает задержку — отставание репликации — пока изменения ожидают применения к базе данных реплики, т.е. база данных реплики всегда «догоняет» основную базу данных. 

## Физический standby с использованием nbackup

Утилита nBackup в Firebird 4 может выполнять физическое резервное копирование, которое использует GUID (UUID) самой последней резервной копии базы данных, доступной только для чтения. Приращения из исходной базы данных можно непрерывно применять к резервной базе данных, устраняя необходимость сохранять и применять все приращения с момента последней полной резервной копии.

Новый стиль «горячего» резервного копирования и слияния с резервной базой данных можно запустить, не затрагивая существующую многоуровневую схему резервного копирования в действующей базе данных. 

## Пул внешних соединений

Чтобы избежать задержек при частой установке внешних подключений, подсистема внешнего источника данных (`EXECUTE STATEMENT ... ON EXTERNAL DATA SOURCE`) была дополнена пулом внешних подключений. Пул сохраняет неиспользуемые внешние соединения в течение определенного периода времени, чтобы уменьшить ненужные накладные расходы из-за частых подключений и отключений клиентов, использующих те же строки подключения. 

## Тайм-ауты

В Firebird 4.0 добавлены настраиваемые тай-ауты:
* тайм-аут простоя соединения (сеанса)
* тайм-аут выполнения SQL запроса

Тайм-аут простоя сеанса позволяет пользовательскому соединению автоматически закрываться после определенного периода бездействия.

Тайм-аут выполнения SQL запроса, позволяет автоматически останавливать выполнение запроса, если он выполняется дольше заданного периода тайм-аута.

## Снимки базы данных на основе порядка фиксации

В Firebird 4.0 кардинально переработана концепция создания моментальных снимков базы данных (snapshot). Ранее для создания моментальных снимков (snapshot) требовалось создать копию TIP (transaction inventory page), в Firebird 4 достаточно просто запомнить номер фиксации (Commit Number). Таким образом, процесс создания моментального снимка в Firebird 4 требует значительно меньше ресурсов, чем ранее.

### Режим изолированности READ COMMITTED READ CONSISTENCY

Поскольку процесс создания моментального снимка в Firebird 4, обходится значительно дешевле чем ранее, то это позволяет создавать такие снимки не только в момент старта транзакции SNAPSHOT, но и для каждого SQL запрос и открытого курсора в новом режиме изолированности транзакции `READ COMMITTED READ CONSISTENCY`. В режиме изолированности `READ COMMITTED READ CONSISTENCY` запросы всегда читают согласованное состояние базы данных на момент старта запроса.

### Промежуточная сборка мусора

Ранее ненужные версии записей (мусор) могли быть удалены, только для версий, 
созданных транзакцией, номер которой меньше чем OST (Oldest Snapshot Transaction). То есть
мусор можно было удалить только из конца цепочки версий. Новая концепция создания моментальных снимков позволила удалять мусор из цепочки версий между активными версиями записи (версий для которых есть активный моментальный снимок). Это позволяет значительно сократить длину цепочки версий при наличии длительных активных транзакций и сократить их негативное влияние на производительность.

## Совместное использование SNAPSHOT транзакций

С помощью этой функции можно создавать параллельные процессы (с использованием разных соединений), читающие согласованные данные из базы данных. Например, процесс резервного копирования может создать несколько потоков, параллельно считывающих данные из базы данных.

## Поддержка международных часовых поясов

В Firebird 4.0 введены новые типы данных `TIME WITH TIME ZONE` и `TIMESTAMP WITH TIME ZONE` для поддержки даты и времени с часовыми поясами, а также типы `TIME WITHOUT TIME ZONE` и `TIMESTAMP WITHOUT TIME ZONE` как псевдонимы существующих типов `TIME` и `TIMESTAMP`.

Поддерживаются выражения и операторы для работы с типами с часовыми поясами, а также преобразование между типами данных без/с часовыми поясами.

## Повышенная точность хранения и вычисления для типов NUMERIC и DECIMAL

Типы NUMERIC и DECIMAL теперь могут хранить числа с точностью до 38 цифр. Для хранения чисел с точностью более 18 Firebird 4.0 использует тип INT128 (128 битное целое). Кроме того улучшена обработка промежуточных результатов вычислений с типами данных NUMERIC и DECIMAL. В предыдущих версиях Firebird числа, поддерживаемые внутренне типом данных BIGINT (то есть с точностью от 10 до 18 десятичных цифр), умножались/делились с использованием того же типа данных BIGINT для результата, что могло вызвать ошибки переполнения из-за ограничения доступной точности. В Firebird 4 такие вычисления выполняются с использованием 128-битных целых чисел, что снижает вероятность неожиданных переполнений. 

Тип INT128 также доступен для использования.

## Тип данных DECFLOAT

DECFLOAT - это числовой тип, соответствующий стандарту SQL:2016, который точно хранит числа с плавающей запятой (десятичный тип с плавающей запятой), в отличие от FLOAT или DOUBLE PRECISION, обеспечивающие двоичное приближение предполагаемой точности. Firebird 4 соответствует типам Decimal64 и Decimal128 из стандарта IEEE 754-1985, обеспечивая для этого типа как 16-значную, так и 34-значную точность.

Все промежуточные вычисления производятся с 34-значными значениями. 

